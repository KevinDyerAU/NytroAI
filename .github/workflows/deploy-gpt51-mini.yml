name: Deploy GPT 5.1 Mini

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment (dev/staging/production)'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - production
      
      deployment_capacity:
        description: 'Deployment capacity (tokens per minute / 1000)'
        required: true
        default: '150'
        type: string
      
      openai_location:
        description: 'Azure location for deployment'
        required: true
        default: 'australiaeast'
        type: choice
        options:
          - australiaeast
          - eastus
          - westus
          - northcentralus
          - swedencentral
      
      sku_name:
        description: 'SKU name for deployment'
        required: true
        default: 'GlobalStandard'
        type: choice
        options:
          - Standard
          - GlobalStandard

env:
  AZURE_RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
  OPENAI_NAME: nytroai-openai-${{ github.event.inputs.environment }}
  OPENAI_LOCATION: ${{ github.event.inputs.openai_location }}
  DEPLOYMENT_NAME: gpt-51-mini
  MODEL_NAME: gpt-51-mini
  MODEL_VERSION: "2024-11-20"

jobs:
  deploy-gpt51-mini:
    name: Deploy GPT 5.1 Mini Model
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4
      
      - name: üîê Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: ‚úÖ Verify Azure OpenAI Resource
        id: verify-openai
        run: |
          set -e
          
          echo "Verifying Azure OpenAI resource: ${{ env.OPENAI_NAME }}"
          echo "Resource Group: ${{ env.AZURE_RESOURCE_GROUP }}"
          
          # Check if Azure OpenAI resource exists
          if ! az cognitiveservices account show \
            --name ${{ env.OPENAI_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            2>/dev/null; then
            
            echo "‚ùå ERROR: Azure OpenAI resource '${{ env.OPENAI_NAME }}' not found"
            echo ""
            echo "Please run the 'Provision Azure Infrastructure' workflow first to create:"
            echo "  - Resource Group: ${{ env.AZURE_RESOURCE_GROUP }}"
            echo "  - Azure OpenAI: ${{ env.OPENAI_NAME }}"
            echo ""
            exit 1
          fi
          
          # Check provisioning state
          PROVISIONING_STATE=$(az cognitiveservices account show \
            --name ${{ env.OPENAI_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query properties.provisioningState -o tsv)
          
          echo "Provisioning state: $PROVISIONING_STATE"
          
          if [ "$PROVISIONING_STATE" != "Succeeded" ]; then
            echo "‚ùå ERROR: Azure OpenAI resource is not in Succeeded state"
            echo "Current state: $PROVISIONING_STATE"
            echo "Please check the Azure Portal and ensure the resource is fully provisioned"
            exit 1
          fi
          
          # Get endpoint
          ENDPOINT=$(az cognitiveservices account show \
            --name ${{ env.OPENAI_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query properties.endpoint -o tsv)
          
          echo "endpoint=$ENDPOINT" >> $GITHUB_OUTPUT
          
          echo "‚úÖ Azure OpenAI resource verified"
          echo "‚úÖ Endpoint: $ENDPOINT"
      
      - name: üöÄ Deploy GPT 5.1 Mini Model
        id: deploy-model
        run: |
          set -e
          
          echo "=========================================="
          echo "Deploying GPT 5.1 Mini"
          echo "=========================================="
          echo "Deployment Name: ${{ env.DEPLOYMENT_NAME }}"
          echo "Model: ${{ env.MODEL_NAME }}"
          echo "Model Version: ${{ env.MODEL_VERSION }}"
          echo "Location: ${{ env.OPENAI_LOCATION }}"
          echo "Capacity: ${{ github.event.inputs.deployment_capacity }}K tokens/min"
          echo "SKU: ${{ github.event.inputs.sku_name }}"
          echo "=========================================="
          echo ""
          
          # Check if deployment already exists
          echo "Checking for existing deployment..."
          DEPLOYMENT_EXISTS=$(az cognitiveservices account deployment list \
            --name ${{ env.OPENAI_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query "[?name=='${{ env.DEPLOYMENT_NAME }}'].name" -o tsv 2>/dev/null || echo "")
          
          if [ -n "$DEPLOYMENT_EXISTS" ]; then
            echo "‚ö†Ô∏è  Deployment '${{ env.DEPLOYMENT_NAME }}' already exists"
            
            # Check deployment status
            DEPLOYMENT_STATE=$(az cognitiveservices account deployment show \
              --name ${{ env.OPENAI_NAME }} \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --deployment-name ${{ env.DEPLOYMENT_NAME }} \
              --query properties.provisioningState -o tsv 2>/dev/null || echo "Unknown")
            
            echo "Current state: $DEPLOYMENT_STATE"
            
            if [ "$DEPLOYMENT_STATE" != "Succeeded" ]; then
              echo "‚ùå ERROR: Deployment exists but is not in Succeeded state"
              echo ""
              echo "Options:"
              echo "1. Wait for deployment to complete (check Azure Portal)"
              echo "2. Delete the deployment and re-run this workflow"
              echo "3. Contact Azure support if deployment is stuck"
              echo ""
              exit 1
            fi
            
            # Get current capacity
            CURRENT_CAPACITY=$(az cognitiveservices account deployment show \
              --name ${{ env.OPENAI_NAME }} \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --deployment-name ${{ env.DEPLOYMENT_NAME }} \
              --query sku.capacity -o tsv 2>/dev/null || echo "Unknown")
            
            echo "Current capacity: ${CURRENT_CAPACITY}K tokens/min"
            echo "Target capacity: ${{ github.event.inputs.deployment_capacity }}K tokens/min"
            
            if [ "$CURRENT_CAPACITY" != "${{ github.event.inputs.deployment_capacity }}" ]; then
              echo ""
              echo "‚ö†Ô∏è  Capacity mismatch detected"
              echo "Updating deployment capacity..."
              
              # Update capacity
              az cognitiveservices account deployment update \
                --name ${{ env.OPENAI_NAME }} \
                --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
                --deployment-name ${{ env.DEPLOYMENT_NAME }} \
                --sku-capacity ${{ github.event.inputs.deployment_capacity }} \
                --sku-name ${{ github.event.inputs.sku_name }}
              
              echo "‚úÖ Deployment capacity updated to ${{ github.event.inputs.deployment_capacity }}K tokens/min"
            else
              echo "‚úÖ Using existing deployment with correct capacity"
            fi
          else
            echo "Creating new GPT 5.1 Mini deployment..."
            echo ""
            
            # Deploy with retry logic
            MAX_RETRIES=3
            RETRY_COUNT=0
            
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              echo "Attempt $((RETRY_COUNT + 1))/$MAX_RETRIES..."
              
              if az cognitiveservices account deployment create \
                --name ${{ env.OPENAI_NAME }} \
                --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
                --deployment-name ${{ env.DEPLOYMENT_NAME }} \
                --model-name ${{ env.MODEL_NAME }} \
                --model-version ${{ env.MODEL_VERSION }} \
                --model-format OpenAI \
                --sku-capacity ${{ github.event.inputs.deployment_capacity }} \
                --sku-name ${{ github.event.inputs.sku_name }}; then
                
                echo ""
                echo "=========================================="
                echo "‚úÖ GPT 5.1 Mini deployed successfully!"
                echo "=========================================="
                echo "Deployment: ${{ env.DEPLOYMENT_NAME }}"
                echo "Location: ${{ env.OPENAI_LOCATION }}"
                echo "Capacity: ${{ github.event.inputs.deployment_capacity }}K tokens/min"
                echo "=========================================="
                break
              else
                RETRY_COUNT=$((RETRY_COUNT + 1))
                if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                  echo "‚ö†Ô∏è  Deployment failed, retrying in 15 seconds..."
                  sleep 15
                else
                  echo ""
                  echo "‚ùå ERROR: Failed to deploy GPT 5.1 Mini after $MAX_RETRIES attempts"
                  echo ""
                  echo "Common issues:"
                  echo "1. Model not available in selected region (${{ env.OPENAI_LOCATION }})"
                  echo "2. Insufficient quota for requested capacity"
                  echo "3. Azure OpenAI service temporarily unavailable"
                  echo ""
                  echo "Troubleshooting:"
                  echo "1. Check model availability: https://learn.microsoft.com/azure/ai-services/openai/concepts/models"
                  echo "2. Try a different region (e.g., eastus, swedencentral)"
                  echo "3. Reduce deployment capacity"
                  echo "4. Check Azure OpenAI quota in Azure Portal"
                  echo ""
                  exit 1
                fi
              fi
            done
          fi
          
          # Wait for deployment to be fully ready
          echo ""
          echo "Waiting for deployment to be fully ready..."
          sleep 10
          
          # Verify deployment is ready
          FINAL_STATE=$(az cognitiveservices account deployment show \
            --name ${{ env.OPENAI_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --deployment-name ${{ env.DEPLOYMENT_NAME }} \
            --query properties.provisioningState -o tsv)
          
          if [ "$FINAL_STATE" != "Succeeded" ]; then
            echo "‚ö†Ô∏è  WARNING: Deployment state is '$FINAL_STATE' (expected 'Succeeded')"
            echo "Deployment may still be provisioning. Check Azure Portal for status."
          else
            echo "‚úÖ Deployment is ready and operational"
          fi
      
      - name: üîë Retrieve Credentials
        id: credentials
        run: |
          set -e
          
          echo "Retrieving Azure OpenAI credentials..."
          
          # Get endpoint
          ENDPOINT=$(az cognitiveservices account show \
            --name ${{ env.OPENAI_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query properties.endpoint -o tsv)
          
          # Get API key
          KEY=$(az cognitiveservices account keys list \
            --name ${{ env.OPENAI_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query key1 -o tsv)
          
          if [ -z "$ENDPOINT" ] || [ -z "$KEY" ]; then
            echo "‚ùå ERROR: Failed to retrieve credentials"
            exit 1
          fi
          
          echo "endpoint=$ENDPOINT" >> $GITHUB_OUTPUT
          echo "key=$KEY" >> $GITHUB_OUTPUT
          
          echo "‚úÖ Credentials retrieved successfully"
      
      - name: üìã Deployment Summary
        run: |
          echo ""
          echo "=========================================="
          echo "üéâ GPT 5.1 Mini Deployment Complete"
          echo "=========================================="
          echo ""
          echo "üì¶ Resource Details:"
          echo "  Resource Group: ${{ env.AZURE_RESOURCE_GROUP }}"
          echo "  Azure OpenAI: ${{ env.OPENAI_NAME }}"
          echo "  Deployment: ${{ env.DEPLOYMENT_NAME }}"
          echo "  Model: ${{ env.MODEL_NAME }} (${{ env.MODEL_VERSION }})"
          echo "  Location: ${{ env.OPENAI_LOCATION }}"
          echo "  Capacity: ${{ github.event.inputs.deployment_capacity }}K tokens/min"
          echo ""
          echo "üîó Connection Details:"
          echo "  Endpoint: ${{ steps.credentials.outputs.endpoint }}"
          echo "  API Key: ****${KEY: -4}"
          echo ""
          echo "‚öôÔ∏è  Next Steps:"
          echo "  1. Set Supabase environment variables:"
          echo "     - AI_PROVIDER=azure"
          echo "     - AZURE_OPENAI_ENDPOINT=${{ steps.credentials.outputs.endpoint }}"
          echo "     - AZURE_OPENAI_KEY=<your-api-key>"
          echo "     - AZURE_OPENAI_DEPLOYMENT=${{ env.DEPLOYMENT_NAME }}"
          echo ""
          echo "  2. Test the deployment with a validation"
          echo ""
          echo "  3. Monitor usage in Azure Portal:"
          echo "     https://portal.azure.com/#@/resource/subscriptions/<subscription-id>/resourceGroups/${{ env.AZURE_RESOURCE_GROUP }}/providers/Microsoft.CognitiveServices/accounts/${{ env.OPENAI_NAME }}"
          echo ""
          echo "=========================================="
          echo ""
          
          # Output credentials for GitHub Actions secrets (masked)
          echo "::add-mask::${{ steps.credentials.outputs.key }}"
          echo "AZURE_OPENAI_ENDPOINT=${{ steps.credentials.outputs.endpoint }}" >> $GITHUB_ENV
          echo "AZURE_OPENAI_KEY=${{ steps.credentials.outputs.key }}" >> $GITHUB_ENV
          echo "AZURE_OPENAI_DEPLOYMENT=${{ env.DEPLOYMENT_NAME }}" >> $GITHUB_ENV

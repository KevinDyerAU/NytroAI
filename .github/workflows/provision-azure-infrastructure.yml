name: Provision Azure Infrastructure

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to provision (dev/staging/production )'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - production
      
      doc_intel_sku:
        description: 'Document Intelligence SKU (F0=Free, S0=Standard)'
        required: true
        default: 'S0'
        type: choice
        options:
          - F0
          - S0
      
      openai_deployment_capacity:
        description: 'OpenAI deployment capacity (tokens per minute / 1000)'
        required: true
        default: '10'
        type: string

env:
  AZURE_RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
  LOCATION: australiaeast
  DOC_INTEL_NAME: nytroai-docintel-${{ github.event.inputs.environment }}
  OPENAI_NAME: nytroai-openai-${{ github.event.inputs.environment }}

jobs:
  provision:
    name: Provision Azure Resources
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
      
      - name: ğŸ” Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: ğŸ“¦ Create or Update Resource Group
        run: |
          echo "Checking resource group: ${{ env.AZURE_RESOURCE_GROUP }}"
          
          # Check if resource group exists
          if az group show --name ${{ env.AZURE_RESOURCE_GROUP }} 2>/dev/null; then
            echo "âš ï¸  Resource group already exists"
            
            # Get existing location
            EXISTING_LOCATION=$(az group show \
              --name ${{ env.AZURE_RESOURCE_GROUP }} \
              --query location -o tsv)
            
            echo "ğŸ“ Existing location: $EXISTING_LOCATION"
            echo "ğŸ“ Target location: ${{ env.LOCATION }}"
            
            # Check if location matches
            if [ "$EXISTING_LOCATION" != "${{ env.LOCATION }}" ]; then
              echo "âŒ ERROR: Resource group exists in different location ($EXISTING_LOCATION)"
              echo "âŒ Cannot change resource group location after creation"
              echo ""
              echo "Options:"
              echo "1. Use existing location: $EXISTING_LOCATION"
              echo "2. Delete resource group and recreate (WARNING: destroys all resources)"
              echo "3. Use a different resource group name"
              echo ""
              echo "To proceed with existing location, update LOCATION env var to: $EXISTING_LOCATION"
              exit 1
            fi
            
            # Update tags on existing resource group
            echo "Updating tags on existing resource group..."
            az group update \
              --name ${{ env.AZURE_RESOURCE_GROUP }} \
              --tags \
                Environment=${{ github.event.inputs.environment }} \
                Project=NytroAI \
                ManagedBy=GitHubActions \
                LastUpdated=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
            
            echo "âœ… Resource group tags updated"
          else
            echo "Creating new resource group: ${{ env.AZURE_RESOURCE_GROUP }}"
            
            az group create \
              --name ${{ env.AZURE_RESOURCE_GROUP }} \
              --location ${{ env.LOCATION }} \
              --tags \
                Environment=${{ github.event.inputs.environment }} \
                Project=NytroAI \
                ManagedBy=GitHubActions \
                CreatedAt=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
            
            echo "âœ… Resource group created successfully"
          fi
      
      - name: ğŸ“„ Provision Document Intelligence
        id: doc-intel
        run: |
          set -e  # Exit on error
          
          echo "Provisioning Document Intelligence: ${{ env.DOC_INTEL_NAME }}"
          echo "Location: ${{ env.LOCATION }}"
          echo "SKU: ${{ github.event.inputs.doc_intel_sku }}"
          
          # Check if resource already exists
          if az cognitiveservices account show \
            --name ${{ env.DOC_INTEL_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            2>/dev/null; then
            
            echo "âš ï¸  Document Intelligence resource already exists"
            
            # Check provisioning state
            PROVISIONING_STATE=$(az cognitiveservices account show \
              --name ${{ env.DOC_INTEL_NAME }} \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --query properties.provisioningState -o tsv)
            
            echo "Provisioning state: $PROVISIONING_STATE"
            
            if [ "$PROVISIONING_STATE" != "Succeeded" ]; then
              echo "âŒ ERROR: Resource exists but is not in Succeeded state"
              echo "Current state: $PROVISIONING_STATE"
              echo "Please check the Azure Portal or delete the resource and retry"
              exit 1
            fi
            
            echo "âœ… Using existing Document Intelligence resource"
          else
            echo "Creating new Document Intelligence resource..."
            
            # Create with retry logic
            MAX_RETRIES=3
            RETRY_COUNT=0
            
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              if az cognitiveservices account create \
                --name ${{ env.DOC_INTEL_NAME }} \
                --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
                --kind FormRecognizer \
                --sku ${{ github.event.inputs.doc_intel_sku }} \
                --location ${{ env.LOCATION }} \
                --custom-domain ${{ env.DOC_INTEL_NAME }} \
                --yes; then
                
                echo "âœ… Document Intelligence resource created successfully"
                break
              else
                RETRY_COUNT=$((RETRY_COUNT + 1))
                if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                  echo "âš ï¸  Creation failed, retrying ($RETRY_COUNT/$MAX_RETRIES)..."
                  sleep 10
                else
                  echo "âŒ ERROR: Failed to create Document Intelligence after $MAX_RETRIES attempts"
                  exit 1
                fi
              fi
            done
          fi
          
          # Get endpoint and key with retry
          echo "Retrieving credentials..."
          
          for i in {1..5}; do
            ENDPOINT=$(az cognitiveservices account show \
              --name ${{ env.DOC_INTEL_NAME }} \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --query properties.endpoint -o tsv 2>/dev/null || echo "")
            
            if [ -n "$ENDPOINT" ]; then
              break
            fi
            
            echo "Waiting for endpoint to be available (attempt $i/5)..."
            sleep 5
          done
          
          if [ -z "$ENDPOINT" ]; then
            echo "âŒ ERROR: Failed to retrieve endpoint"
            exit 1
          fi
          
          KEY=$(az cognitiveservices account keys list \
            --name ${{ env.DOC_INTEL_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query key1 -o tsv)
          
          if [ -z "$KEY" ]; then
            echo "âŒ ERROR: Failed to retrieve API key"
            exit 1
          fi
          
          # Set outputs for later steps
          echo "endpoint=$ENDPOINT" >> $GITHUB_OUTPUT
          echo "key=$KEY" >> $GITHUB_OUTPUT
          
          echo "âœ… Document Intelligence Endpoint: $ENDPOINT"
          echo "âœ… Credentials retrieved successfully"
      
      - name: ğŸ¤– Provision Azure OpenAI
        id: openai
        run: |
          set -e  # Exit on error
          
          echo "Provisioning Azure OpenAI: ${{ env.OPENAI_NAME }}"
          echo "Location: ${{ env.LOCATION }}"
          
          # Check if resource already exists
          if az cognitiveservices account show \
            --name ${{ env.OPENAI_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            2>/dev/null; then
            
            echo "âš ï¸  Azure OpenAI resource already exists"
            
            # Check provisioning state
            PROVISIONING_STATE=$(az cognitiveservices account show \
              --name ${{ env.OPENAI_NAME }} \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --query properties.provisioningState -o tsv)
            
            echo "Provisioning state: $PROVISIONING_STATE"
            
            if [ "$PROVISIONING_STATE" != "Succeeded" ]; then
              echo "âŒ ERROR: Resource exists but is not in Succeeded state"
              echo "Current state: $PROVISIONING_STATE"
              echo "Please check the Azure Portal or delete the resource and retry"
              exit 1
            fi
            
            echo "âœ… Using existing Azure OpenAI resource"
          else
            echo "Creating new Azure OpenAI resource..."
            
            # Create with retry logic
            MAX_RETRIES=3
            RETRY_COUNT=0
            
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              if az cognitiveservices account create \
                --name ${{ env.OPENAI_NAME }} \
                --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
                --kind OpenAI \
                --sku S0 \
                --location ${{ env.LOCATION }} \
                --custom-domain ${{ env.OPENAI_NAME }} \
                --yes; then
                
                echo "âœ… Azure OpenAI resource created successfully"
                break
              else
                RETRY_COUNT=$((RETRY_COUNT + 1))
                if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                  echo "âš ï¸  Creation failed, retrying ($RETRY_COUNT/$MAX_RETRIES)..."
                  sleep 10
                else
                  echo "âŒ ERROR: Failed to create Azure OpenAI after $MAX_RETRIES attempts"
                  exit 1
                fi
              fi
            done
          fi
          
          # Get endpoint and key with retry
          echo "Retrieving credentials..."
          
          for i in {1..5}; do
            ENDPOINT=$(az cognitiveservices account show \
              --name ${{ env.OPENAI_NAME }} \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --query properties.endpoint -o tsv 2>/dev/null || echo "")
            
            if [ -n "$ENDPOINT" ]; then
              break
            fi
            
            echo "Waiting for endpoint to be available (attempt $i/5)..."
            sleep 5
          done
          
          if [ -z "$ENDPOINT" ]; then
            echo "âŒ ERROR: Failed to retrieve endpoint"
            exit 1
          fi
          
          KEY=$(az cognitiveservices account keys list \
            --name ${{ env.OPENAI_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query key1 -o tsv)
          
          if [ -z "$KEY" ]; then
            echo "âŒ ERROR: Failed to retrieve API key"
            exit 1
          fi
          
          # Set outputs
          echo "endpoint=$ENDPOINT" >> $GITHUB_OUTPUT
          echo "key=$KEY" >> $GITHUB_OUTPUT
          
          echo "âœ… Azure OpenAI Endpoint: $ENDPOINT"
          echo "âœ… Credentials retrieved successfully"
      
      - name: ğŸš€ Deploy GPT-4.1 Model
        id: gpt-deployment
        run: |
          set -e  # Exit on error
          
          echo "Deploying GPT-4.1 model to Australia East..."
          
          DEPLOYMENT_NAME="gpt-4.1"
          # After (GPT-4o - works perfectly)
          MODEL_NAME="gpt-4o"
          MODEL_VERSION="2024-11-20"
          
          echo "Deployment: $DEPLOYMENT_NAME"
          echo "Model: $MODEL_NAME (version: $MODEL_VERSION)"
          echo "Capacity: ${{ github.event.inputs.openai_deployment_capacity }}K tokens/min"
          
          # Check if deployment already exists
          DEPLOYMENT_EXISTS=$(az cognitiveservices account deployment list \
            --name ${{ env.OPENAI_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query "[?name=='$DEPLOYMENT_NAME'].name" -o tsv 2>/dev/null || echo "")
          
          if [ -n "$DEPLOYMENT_EXISTS" ]; then
            echo "âš ï¸  GPT-4.1 deployment already exists"
            
            # Check deployment status
            DEPLOYMENT_STATE=$(az cognitiveservices account deployment show \
              --name ${{ env.OPENAI_NAME }} \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --deployment-name $DEPLOYMENT_NAME \
              --query properties.provisioningState -o tsv 2>/dev/null || echo "Unknown")
            
            echo "Deployment state: $DEPLOYMENT_STATE"
            
            if [ "$DEPLOYMENT_STATE" != "Succeeded" ]; then
              echo "âŒ ERROR: Deployment exists but is not in Succeeded state"
              echo "Current state: $DEPLOYMENT_STATE"
              echo "Please check the Azure Portal or delete the deployment and retry"
              exit 1
            fi
            
            echo "âœ… Using existing GPT-4.1 deployment"
          else
            echo "Creating GPT-4.1 deployment (Global Standard in Australia East)..."
            echo "Note: GPT-4.1 is available in Australia East for data sovereignty compliance"
            
            # Deploy with retry logic
            MAX_RETRIES=3
            RETRY_COUNT=0
            
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              if az cognitiveservices account deployment create \
                --name ${{ env.OPENAI_NAME }} \
                --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
                --deployment-name $DEPLOYMENT_NAME \
                --model-name $MODEL_NAME \
                --model-version $MODEL_VERSION \
                --model-format OpenAI \
                --sku-capacity ${{ github.event.inputs.openai_deployment_capacity }} \
                --sku-name Standard; then
                
                echo "âœ… GPT-4.1 model deployed successfully in Australia East"
                echo "âœ… Data sovereignty: All processing occurs in Australian region"
                break
              else
                RETRY_COUNT=$((RETRY_COUNT + 1))
                if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                  echo "âš ï¸  Deployment failed, retrying ($RETRY_COUNT/$MAX_RETRIES)..."
                  sleep 15
                else
                  echo "âŒ ERROR: Failed to deploy GPT-4.1 after $MAX_RETRIES attempts"
                  echo ""
                  echo "Possible issues:"
                  echo "1. Model not available in Australia East (check region support)"
                  echo "2. Quota exceeded (check Azure OpenAI quota limits)"
                  echo "3. Capacity not available (try lower capacity value)"
                  echo ""
                  echo "Troubleshooting:"
                  echo "- Check Azure Portal for detailed error messages"
                  echo "- Verify GPT-4.1 availability in Australia East"
                  echo "- Request quota increase if needed"
                  exit 1
                fi
              fi
            done
            
            # Wait for deployment to be ready
            echo "Waiting for deployment to be ready..."
            for i in {1..12}; do
              DEPLOYMENT_STATE=$(az cognitiveservices account deployment show \
                --name ${{ env.OPENAI_NAME }} \
                --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
                --deployment-name $DEPLOYMENT_NAME \
                --query properties.provisioningState -o tsv 2>/dev/null || echo "Unknown")
              
              echo "Deployment state: $DEPLOYMENT_STATE (check $i/12)"
              
              if [ "$DEPLOYMENT_STATE" = "Succeeded" ]; then
                echo "âœ… Deployment is ready"
                break
              fi
              
              if [ $i -eq 12 ]; then
                echo "âš ï¸  Warning: Deployment may still be provisioning"
                echo "Current state: $DEPLOYMENT_STATE"
              fi
              
              sleep 10
            done
          fi
          
          echo "deployment_name=$DEPLOYMENT_NAME" >> $GITHUB_OUTPUT
          echo "âœ… GPT-4.1 deployment complete"
      
      - name: ğŸ“Š Generate Summary
        run: |
          echo "## âœ… Azure Infrastructure Provisioned Successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“¦ Resources Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Resource Type | Resource Name | Location | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------------|---------------|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Resource Group | \`${{ env.AZURE_RESOURCE_GROUP }}\` | ${{ env.LOCATION }} | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| Document Intelligence | \`${{ env.DOC_INTEL_NAME }}\` | ${{ env.LOCATION }} | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| Azure OpenAI | \`${{ env.OPENAI_NAME }}\` | ${{ env.LOCATION }} | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| GPT-4.1 Deployment | \`${{ steps.gpt-deployment.outputs.deployment_name }}\` | - | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ”‘ Credentials for Supabase Secrets" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Add these to your Supabase project secrets:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "AZURE_DOC_INTEL_ENDPOINT=${{ steps.doc-intel.outputs.endpoint }}" >> $GITHUB_STEP_SUMMARY
          echo "AZURE_DOC_INTEL_KEY=${{ steps.doc-intel.outputs.key }}" >> $GITHUB_STEP_SUMMARY
          echo "AZURE_OPENAI_ENDPOINT=${{ steps.openai.outputs.endpoint }}" >> $GITHUB_STEP_SUMMARY
          echo "AZURE_OPENAI_KEY=${{ steps.openai.outputs.key }}" >> $GITHUB_STEP_SUMMARY
          echo "AZURE_OPENAI_DEPLOYMENT=${{ steps.gpt-deployment.outputs.deployment_name }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“‹ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Copy the credentials above" >> $GITHUB_STEP_SUMMARY
          echo "2. Go to Supabase Dashboard â†’ Project Settings â†’ Edge Functions" >> $GITHUB_STEP_SUMMARY
          echo "3. Add each secret using the 'Add secret' button" >> $GITHUB_STEP_SUMMARY
          echo "4. Deploy your updated Edge Functions" >> $GITHUB_STEP_SUMMARY
          echo "5. Test the integration" >> $GITHUB_STEP_SUMMARY
      
      - name: ğŸ’¾ Save Credentials to File
        run: |
          mkdir -p .azure-credentials
          
          cat > .azure-credentials/credentials-${{ github.event.inputs.environment }}.txt << EOF
          # Azure Credentials for NytroAI - ${{ github.event.inputs.environment }}
          # Generated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          # DO NOT COMMIT THIS FILE TO GIT
          
          AZURE_DOC_INTEL_ENDPOINT=${{ steps.doc-intel.outputs.endpoint }}
          AZURE_DOC_INTEL_KEY=${{ steps.doc-intel.outputs.key }}
          AZURE_OPENAI_ENDPOINT=${{ steps.openai.outputs.endpoint }}
          AZURE_OPENAI_KEY=${{ steps.openai.outputs.key }}
          AZURE_OPENAI_DEPLOYMENT=${{ steps.gpt-deployment.outputs.deployment_name }}
          EOF
          
          echo "âœ… Credentials saved to .azure-credentials/credentials-${{ github.event.inputs.environment }}.txt"
      
      - name: ğŸ“¤ Upload Credentials Artifact
        uses: actions/upload-artifact@v4
        with:
          name: azure-credentials-${{ github.event.inputs.environment }}
          path: .azure-credentials/credentials-${{ github.event.inputs.environment }}.txt
          retention-days: 7
      
      - name: ğŸ‰ Provisioning Complete
        run: |
          echo "============================================"
          echo "âœ… Azure infrastructure provisioned successfully!"
          echo "============================================"
          echo ""
          echo "Environment: ${{ github.event.inputs.environment }}"
          echo "Location: ${{ env.LOCATION }}"
          echo ""
          echo "Next: Add credentials to Supabase Secrets"
          echo "============================================"
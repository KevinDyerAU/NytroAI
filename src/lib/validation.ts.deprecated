import { S3Client, PutObjectCommand } from '@aws-sdk/client-s3';

interface ValidationPayload {
  s3Path: string;
  pineconeNamespace: string;
  unitLink: string;
  validationType: string;
  files?: Array<{
    name: string;
    url: string;
  }>;
}

const getS3Client = () => {
  const accessKeyId = import.meta.env.VITE_AWS_ACCESS_KEY_ID;
  const secretAccessKey = import.meta.env.VITE_AWS_SECRET_ACCESS_KEY;

  if (!accessKeyId || !secretAccessKey) {
    throw new Error('AWS credentials not configured');
  }

  return new S3Client({
    region: 'ap-southeast-2',
    credentials: {
      accessKeyId,
      secretAccessKey,
    },
  });
};

export async function uploadFilesToStorage(
  files: Array<{ name: string; file: File }>,
  folderPath: string
): Promise<Array<{ name: string; url: string }>> {
  const uploadedFiles: Array<{ name: string; url: string }> = [];
  const s3Client = getS3Client();
  const bucketName = 'smartrtobucket';

  for (const { name, file } of files) {
    const s3Key = `${folderPath}/${name}`;
    const arrayBuffer = await file.arrayBuffer();

    const command = new PutObjectCommand({
      Bucket: bucketName,
      Key: s3Key,
      Body: new Uint8Array(arrayBuffer),
      ContentType: file.type,
    });

    try {
      await s3Client.send(command);

      const s3Url = `https://${bucketName}.s3.ap-southeast-2.amazonaws.com/${s3Key}`;
      uploadedFiles.push({
        name,
        url: s3Url,
      });
    } catch (error) {
      console.error(`Error uploading file ${name} to S3:`, error instanceof Error ? error.message : JSON.stringify(error));
      throw error;
    }
  }

  return uploadedFiles;
}

export async function callValidationWebhook(payload: ValidationPayload): Promise<boolean> {
  const webhookUrl = 'https://n8n-gtoa.onrender.com/webhook/df87caee-851a-4e8d-a5b9-af82bc549dc6';

  try {
    console.log('Calling webhook with payload:', payload);

    const response = await fetch(webhookUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(payload),
    });

    console.log('Webhook response status:', response.status);

    if (!response.ok) {
      const errorText = await response.text();
      console.error('Webhook error response:', errorText);
      throw new Error(`Webhook failed with status ${response.status}: ${errorText}`);
    }

    const responseData = await response.json();
    console.log('Webhook response data:', responseData);

    return true;
  } catch (error) {
    console.error('Error calling validation webhook:', error);
    console.error('Webhook URL attempted:', webhookUrl);

    // Check if it's a network error
    if (error instanceof TypeError && error.message.includes('Failed to fetch')) {
      console.error('Network error - webhook endpoint may be unreachable or blocked by CORS');
    }

    throw error;
  }
}

export function createFolderName(rtoCode: string, unitCode: string, validationType: string): string {
  const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
  return `${rtoCode}/${unitCode}/${validationType}/${timestamp}`;
}

export function createS3Path(folderName: string): string {
  return `s3://smartrtobucket/${folderName}/`;
}

export function createPineconeNamespace(folderName: string): string {
  return folderName;
}

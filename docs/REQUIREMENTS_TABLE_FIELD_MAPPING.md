# Requirements Table Field Mapping

This document maps the correct field names from each requirements table to ensure the `get-requirements` edge function returns the actual requirement text.

---

## Table Schemas

### 1. `knowledge_evidence_requirements`
```sql
CREATE TABLE public.knowledge_evidence_requirements (
  unit_url text null,
  knowledge_point text null,           -- ✅ THIS IS THE TEXT FIELD
  created_at timestamp with time zone null default now(),
  id bigint generated by default as identity not null,
  ke_number text null,                 -- ✅ THIS IS THE NUMBER FIELD
  constraint knowledge_evidence_requirements_pkey primary key (id)
);
```

**Field Mapping:**
- `number` → `ke_number`
- `text` → `knowledge_point`
- `description` → `knowledge_point` (same as text)

---

### 2. `performance_evidence_requirements`
```sql
CREATE TABLE public.performance_evidence_requirements (
  unit_url text null,
  performance_task text null,          -- ✅ THIS IS THE TEXT FIELD
  created_at timestamp with time zone null default now(),
  id bigint generated by default as identity not null,
  pe_number text null,                 -- ✅ THIS IS THE NUMBER FIELD
  constraint performance_evidence_requirements_pkey primary key (id)
);
```

**Field Mapping:**
- `number` → `pe_number`
- `text` → `performance_task`
- `description` → `performance_task` (same as text)

---

### 3. `foundation_skills_requirements`
```sql
CREATE TABLE public.foundation_skills_requirements (
  unit_url text null,
  skill_description text null,         -- ✅ THIS IS THE TEXT FIELD
  created_at timestamp with time zone null default now(),
  id bigint generated by default as identity not null,
  fs_number text null,                 -- ✅ THIS IS THE NUMBER FIELD
  skill_category text null,
  constraint foundation_skills_requirements_pkey primary key (id)
);
```

**Field Mapping:**
- `number` → `fs_number`
- `text` → `skill_description`
- `description` → `skill_description` (same as text)

---

### 4. `elements_performance_criteria_requirements`
```sql
CREATE TABLE public.elements_performance_criteria_requirements (
  unit_url text null,
  performance_criteria text null,      -- ✅ THIS IS THE TEXT FIELD
  created_at timestamp with time zone null default now(),
  id bigint generated by default as identity not null,
  epc_number text null,                -- ✅ THIS IS THE NUMBER FIELD
  element text null,                   -- Element description (context)
  constraint elements_performance_criteria_requirements_pkey primary key (id)
);
```

**Field Mapping:**
- `number` → `epc_number`
- `text` → `performance_criteria`
- `description` → `performance_criteria` (same as text)
- `element` → Additional context field

---

### 5. `assessment_conditions_requirements`
```sql
CREATE TABLE public.assessment_conditions_requirements (
  unit_url text null,
  condition_text text null,            -- ✅ THIS IS THE TEXT FIELD
  created_at timestamp with time zone null default now(),
  id bigint generated by default as identity not null,
  ac_number text null,                 -- ✅ THIS IS THE NUMBER FIELD
  constraint assessment_conditions_requirements_pkey primary key (id)
);
```

**Field Mapping:**
- `number` → `ac_number`
- `text` → `condition_text`
- `description` → `condition_text` (same as text)

---

## Corrected Edge Function Mapping

### Current (BROKEN) Code:
```typescript
const requirements = data.map((item: any, index: number) => ({
  id: item.id,
  number: item.requirement_number || item.number || String(index + 1),
  text: item.knowledge_point || item.performance_task || item.skill_description || item.text || item.description || '',
  type: table.type,
  description: item.description || item.knowledge_point || item.performance_task || item.skill_description || ''
}));
```

**Problem:** Falls back to generic fields that don't exist, returns empty strings.

---

### Fixed Code (TABLE-SPECIFIC MAPPING):
```typescript
// Fetch from each table with table-specific field mapping
for (const table of tables) {
  try {
    const { data, error } = await supabaseClient
      .from(table.name)
      .select('*')
      .eq('unit_url', unit_url);

    if (error) {
      console.warn(`[Get Requirements] Error fetching from ${table.name}:`, error.message);
      continue;
    }

    if (data && data.length > 0) {
      // Map fields based on table type
      const requirements = data.map((item: any, index: number) => {
        let number = String(index + 1);
        let text = '';
        let description = '';

        // Table-specific field mapping
        switch (table.type) {
          case 'knowledge_evidence':
            number = item.ke_number || String(index + 1);
            text = item.knowledge_point || '';
            description = item.knowledge_point || '';
            break;
          
          case 'performance_evidence':
            number = item.pe_number || String(index + 1);
            text = item.performance_task || '';
            description = item.performance_task || '';
            break;
          
          case 'foundation_skills':
            number = item.fs_number || String(index + 1);
            text = item.skill_description || '';
            description = item.skill_description || '';
            break;
          
          case 'elements_performance_criteria':
            number = item.epc_number || String(index + 1);
            text = item.performance_criteria || '';
            description = item.element ? `${item.element}: ${item.performance_criteria}` : item.performance_criteria || '';
            break;
          
          case 'assessment_conditions':
            number = item.ac_number || String(index + 1);
            text = item.condition_text || '';
            description = item.condition_text || '';
            break;
        }

        return {
          id: item.id,
          number,
          text,
          type: table.type,
          description
        };
      });
      
      allRequirements.push(...requirements);
      console.log(`[Get Requirements] ✓ Fetched ${requirements.length} from ${table.name}`);
    } else {
      console.log(`[Get Requirements] - No requirements in ${table.name}`);
    }
  } catch (error: any) {
    console.error(`[Get Requirements] ✗ Failed to fetch from ${table.name}:`, error.message);
  }
}
```

---

## Summary

| Table | Number Field | Text Field | Description Field | Display Type |
|-------|--------------|------------|-------------------|-------------|
| `knowledge_evidence_requirements` | `ke_number` | `knowledge_point` | `knowledge_point` | `Knowledge Evidence` |
| `performance_evidence_requirements` | `pe_number` | `performance_task` | `performance_task` | `Performance Evidence` |
| `foundation_skills_requirements` | `fs_number` | `skill_description` | `skill_description` | `Foundation Skills` |
| `elements_performance_criteria_requirements` | `epc_number` | `performance_criteria` | `element` + `performance_criteria` | `Performance Criteria` |
| `assessment_conditions_requirements` | `ac_number` | `condition_text` | `condition_text` | `Assessment Conditions` |

**Additional fields for Performance Criteria:**
- `element`: Parent element name (e.g., "Prepare for driving")
- `element_number`: Extracted from `epc_number` (e.g., "1" from "1.1")

---

**Last Updated:** 2025-11-30  
**Related File:** `supabase/functions/get-requirements/index.ts`
